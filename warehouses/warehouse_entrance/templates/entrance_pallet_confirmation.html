{% extends 'base.html' %}
{% load staticfiles %}
{% load i18n %}
{% load l10n %}

{% block content-header %}
<h1>
  <small>{% block header-subtitle %}{% endblock %}</small>
</h1>
<ol class="breadcrumb">
  <li><a href="{% url 'main-dashboard' %}"><i class="fa fa-dashboard"></i> {% trans 'Home' %}</a></li>
  <li><a href="{% url 'warehouse-entrances-list' %}">{% trans 'WAREHOUSE-ENTRANCE-APPOINTMENTS' %}</a></li>
  <li class="active">{{warehouseentrance.id}}</li>
</ol>
{% endblock %}



<a href="{% url 'packaging-list' %}"></a>

{% block content %}
<div class="parent-loader"></div>
<div class="row">
  <div class="col-md-12">
    <div class="box box-primary">
      <input type="hidden" id="id_customer" data-name="{{object.customer}}" value="{{object.customer.id}}">

      <input type="hidden" id="id_customer_barcoderead" data-barcoderead="{{object.customer.barcoderead}}" value="{{object.customer.barcoderead}}">

      <form id="sga-form" role="form" method="post" enctype="multipart/form-data">
        <div class="box-header with-border">
          <div class="row">
            <div class="col-md-6 pull-right">
              <div class="col-sm-3">
                <button type="button" class="btn btn-success send_to_maneuvers">{% trans 'Send to Maneuvers' %}</button>
              </div>
              <div class="col-sm-3">
                <button type="button" class="btn btn-primary" id="confirm_button">{% trans 'CONFIRM ENTRANCE' %}</button>
              </div>
              <div class="col-sm-2">
                <button type="submit" class="btn btn-primary" id="sga-entrance-form">{% trans 'Save' %}</button>
              </div>
              <div class="col-sm-2">
                <a href="/warehouse_entrance/warehouse-entrances-list" class="btn  btn-default">{% trans 'Cancel' %}</a>
              </div>
            </div>
          </div>
        </div>

        {% csrf_token %}
        <div class="box-body">
          <input type="hidden" name="print_picking" value="0" id="print_picking_text">
          <input type="hidden" name="status" value="{{object.status}}" id="id_status">

        <div class="box-body">
          <div class="row">            
            {% include 'form-error.html' %}
            </div> 

            <div class="modal-header">
                  <h4 class="modal-title" id="myModalLabel">{% trans 'WAREHOUSE ENTRANCE CONFIRMATION' %}
                  </h4>

                </div>      

                <div class="modal-body" >
                  <div class="row">

                    <div class="col-md-12">
                      <table class="table new-tab">
                        <thead>
                          <tr><th class="input-group-0">ID
                          </th>
                          <th class="pallet_th_i"> 
                            {% trans 'Product' %}
                          </th>
                          <th class="pallet_th_i">
                            {% trans 'Description' %}
                          </th>
                          <th class="pallet_th_i">
                            {% trans 'Kg Totales' %}
                          </th>

                          <th class="pallet_th_i">
                            {% trans 'Piezas' %}
                          </th>

                          <th class="pallet_th_i">
                            {% trans 'Kg X pieza' %}
                          </th>

                          <th class="pallet_th_i">
                            {% trans 'Cajas' %}
                          </th>

                          <th class="pallet_th_i">
                            {% trans 'Kg X Caja' %}
                          </th>

                        </tr>
                      </thead>
                      <tbody class="partial_product points_table_scrollbar">
                        {% with object.list_product as list_products %}  
                          {% for product_measure in list_products %}
                              <tr data-row='product-{{forloop.counter0}}-location' data-measurement='{{product_measure.id}}' >
                                <td class='input-group-0'>{{forloop.counter}}</td>
                                <td>
                                  <input type="hidden" name="" class="product_bar_code" value="{{product_measure.product.barcode_to_use }}">
                                  <div class='form-group td-group'>
                                    <span onfocus='this.blur()' class='form-control input-group product_code'><p>{{product_measure.product}}</p></span>
                                  </div>
                                </td>
                                <td>
                                  <div class='form-group td-group'>
                                    <span  onfocus='this.blur()' class='form-control input-group product_description'><p>{{product_measure.product_description }}</p></span>
                                  </div>
                                </td>
                                <td>
                                  <div class='form-group td-group'>
                                    <span onfocus='this.blur()' class='form-control input-group total_kg'><p>{{product_measure.total_kg | unlocalize}}</p></span>
                                  </div>

                                  
                                  <input type='hidden' value = {{product_measure.product.packages_per_pallet}} class='product_pallet'>

                                  <input type='hidden' value = '{{product_measure.product.id}}' class='product_id'>
                                  <input type='hidden' value = '{{product_measure.product.net_weight|unlocalize}}' class='product_net_weight'>
                                </td>
                                <td>
                                  <div class='form-group td-group'>
                                    <span  onfocus='this.blur()' class='form-control input-group total_price'><p>{{product_measure.price | unlocalize}}</p></span>
                                  </div>
                                </td>
                                <td>
                                  <div class='form-group td-group'>
                                    <span  onfocus='this.blur()' class='form-control input-group kg_per_price'><p>{{product_measure.kg_per_price | unlocalize}}</p></span>
                                  </div>
                                </td>
                                <td>
                                  <div class='form-group td-group'>
                                    <span  onfocus='this.blur()' class='form-control input-group  boxes'><p>{{product_measure.boxes | unlocalize}}</p></span>
                                  </div>
                                </td>
                                <td>
                                  <div class='form-group td-group'>
                                    <span  onfocus='this.blur()' class='form-control input-group kg_per_boxes'><p>{{product_measure.kg_per_boxes | unlocalize }}</p></span>
                                  </div>
                                </td>
                              </tr>
                          {% endfor  %}
                        {% endwith %}
                      </tbody>
                    </table>

                  </div>
                </div>
                <hr>
                <div class="row">
                  <div class="col-md-12" id="entrance_product_detail">
                    {{ w_entrance_confirmation_pallet.management_form }}
                    <div class="form-group col-xs-12 form-group-list">
                      {% with w_entrance_confirmation_pallet as w_entrance_confirmation_pallets %} 
                        {% for entrance_confirmation in w_entrance_confirmation_pallets %}
                          {{ entrance_confirmation.id }}
                          <div class="row {{ w_entrance_confirmation_pallets.prefix }}" data-role="w_entrance_confirmation_pallet_row_{{ entrance_confirmation.instance.w_product_measurement.id }}">
                            {% for field in entrance_confirmation %}

                            <div class="col-sm-1 form-group" style="width: 12.333333% !important">
                              {% if not field.is_hidden %}
                              {% if field.name == "w_product_measurement" %}
                              <div class="hide">
                                {{ field }}
                              </div> 
                              {% else %}
                              {{ field.label_tag }}
                              {{ field }}
                              {% endif %}

                              {% endif %}
                            </div>
                            {% endfor %}

                            {% if entrance_confirmation.nested %}
                            <div class="table-scroll">
                              <div class="col-md-12">
                                <table class="table new-tab">
                                  <thead>
                                    <tr>
                                      <th class="input-group-th pallet_th"> 
                                        {% trans 'Palet Lot' %}
                                      </th>
                                      <th class="input-group-th pallet_th">
                                        {% trans 'Boxes' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Box Kg' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Warehouse' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Rack Number' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Location' %}
                                      </th>
                                      <th class="input-group-th pallet_th">
                                        {% trans 'Cust Lot' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Expiration Date' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Gross Weight' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Net Weight' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Entrance Invoice Weight' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Retained Qty' %}
                                      </th>

                                      <th class="input-group-th pallet_th">
                                        {% trans 'Retainment Reason' %}
                                      </th>                               
                                      {% if entrance_confirmation.instance.get_total_palet %}
                                      <th class="input-group-th pallet_th">
                                        <a role="button" conf-data="{{entrance_confirmation.id.value}}" href="javascript:void(0)" class="btn btn-default qr_generater_button" style="width: 37px;height: 34px; border-radius: 3px; padding: 5px; border-color: yellow;"><img src="{% static 'theme/img/QR_code.png' %}" style="width: 100%;"></a>
                                      </th>
                                      {%endif%}

                                      <th class="input-group-th pallet_th">
                                        &nbsp;&nbsp;&nbsp;&nbsp;
                                      </th>
                                    </tr>
                                  </thead>

                                </table>

                              </div>
                              <div class="pallete_form_list">    
                                {{ entrance_confirmation.nested.management_form }}
                                {{ entrance_confirmation.nested.non_form_errors }}

                                {% for pallet_form in entrance_confirmation.nested.forms %}
                                <div class="row col-xs-12 table-row">
                                  {% for field in pallet_form %}
                                  {% if field.name == "id"  %}
                                  <div class="col-sm-2 form-group pallet_column empty-block id-pallet" data-pallet-id="{{ field.value }}">
                                    {{ field }}
                                  </div> 
                                  {% elif field.name == "werehouse_entrance_confirmation" %}
                                  <div class="col-sm-2 form-group pallet_column empty-block">
                                    {{ field }}
                                  </div> 

                                  {% elif field.name == "DELETE" %}
                                  <div class="col-sm-2 form-group pallet_column delete-block">
                                    {{ field }}
                                  </div>  

                                  {%else%}
                                  <div class="col-sm-2 form-group pallet_column">
                                    {{ field }}
                                  </div>
                                  {%endif%}
                                  {% endfor %}
                                  <div class="col-sm-2 form-group pallet_column" >
                                    <a href="javascript:void(0)" class="btn btn-primary appDetails" style="margin-top: -25px;">Mapa</a>
                                  </div>

                                  <div class="col-sm-2 form-group pallet_column" >
                                    <a href="javascript:void(0)" class="btn btn-success romaneo" style="margin-top: -25px;">{% trans 'ROMANEO' %}</a>

                                  </div>

                                </div>

                                {% endfor %}

                              </div>



                              <div class="row col-xs-12 table-row-total">
                                <div class="col-sm-2 form-group total-block text-right">
                                  Total
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                  <input type="text" name="" class="form-control total_boxes" value="0" readonly="true">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                  <input type="text" name="" class="form-control total_gross_weight" value="0" readonly="true">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                  <input type="text" name="" class="form-control total_net_weight" value="0" readonly="true">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                                <div class="col-sm-2 form-group total-block delete-block">
                                </div>
                                <div class="col-sm-2 form-group total-block">
                                </div>
                              </div>
                            </div>
                            <!-- empty pallate form -->
                            <div class="hide empty_pallate_detail_form">

                              <div class="row col-xs-12 table-row">
                                {% for field in entrance_confirmation.nested.empty_form %}
                                {% if field.name == "werehouse_entrance_confirmation" or field.name == "id"  %}
                                <div class="col-sm-2 form-group pallet_column empty-block">
                                  {{ field }}
                                </div> 

                                {% elif field.name == "DELETE" %}
                                <div class="col-sm-2 form-group pallet_column delete-block">
                                  {{ field }}
                                </div>                            
                                {%else%}
                                <div class="col-sm-2 form-group pallet_column">
                                  {{ field }}
                                </div>
                                {% endif %}
                                {% endfor %}
                                <div class="col-sm-2 form-group pallet_column" >
                                  <a href="javascript:void(0)" class="btn btn-primary appDetails" style="margin-top: -25px;" >Mapa</a>
                                </div>
                              </div>
                            </div>

                            {% endif %}

                            <div class="btn-line text-right">
                              <button type="button" class="btn btn-primary submit_data">Guardar</button>
                            </div>

                          </div>


                          <hr>
                        {% endfor %}
                      {% endwith %}
                    </div>  
                  </div>                       
                </div> 

                <div id="empty_product_detail_form" class="hide">


                  <!-- <div class="row warehouseentranceconfirmation_set " data-role="w_entrance_confirmation_pallet_row___prefix__"> -->
                    <div class="row warehouseentranceconfirmation_set w_entrance_confirmation_pallet_row_details___prefix__" data-role="w_entrance_confirmation_pallet_row___prefix__">
                    {{w_entrance_confirmation_pallet.empty_form.id}}
                    {% for field in w_entrance_confirmation_pallet.empty_form %}

                    <div class="col-sm-1 form-group" style="width: 12.333333% !important">
                      {% if not field.is_hidden %}
                        {%if field.name == "w_product_measurement" %}
                          <div class="hide">
                          {{ field }}
                          </div>
                        {%else%}
                          {{ field.label_tag }}
                          {{ field }}
                        {% endif %}
                      {% endif %}
                    </div>
                    {% endfor %}                    

                  </div>
                </div>            

              </div>    


          <div class="modal fade" id="modal-sure-confirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog sure-confirmation">
              <div class="modal-content text-center">

                <div class="modal-body confirm-sure">
                  <p style="margin: 0 0 30px 0;">{% trans 'Do you wish to confirm the entrance of the selected products and location?' %}</p>

                  <button type="button" class="btn btn-primary" id="accept">{%trans 'Accept' %}</button>
                  <button type="button" class="btn btn-default" id="reject">{%trans 'Cancel' %}</button>

                </div>
              </div>
            </div>
          </div>


          <div class="modal fade" id="modal-error-confirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog error-confirmation">
              <div class="modal-content text-center">

                <div class="modal-body confirm-sure">
                  <p style="margin: 0 0 30px 0;">{% trans 'there are products with missing data and/or location definition , please check' %}</p>              

                  <button type="button" class="btn btn-default" data-dismiss="modal">{%trans 'Cancel' %}</button>

                </div>
              </div>
            </div>
          </div>
           <div class="modal fade romaneo-confirm" id="modal-romaneo-confirm"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" data-keyboard="false" >
            <div class="modal-dialog sure-confirmation">
              <div class="modal-content text-center">

                <div class="modal-body confirm-sure">
                  <p style="margin: 0 0 30px 0;"></p>

                  <button type="button" class="btn btn-primary" id="romaneo-yes">{%trans 'Yes' %}</button>
                  <button type="button" class="btn btn-default" id="romaneo-No">{%trans 'No' %}</button>

                </div>
              </div>
            </div>
          </div>

      </form>
    </div>
  </div>
</div>

<div id="pallet_romaneo" class="modal fade" role="dialog" width="90%;" aria-labelledby="myModalLabel"  data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog romaneo-peso-modal" data-backdrop="false" style="width: 80% !important;">
    <div class="modal-content" style="
      border-radius: 6px;">
      <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">ROMANEO-PESO VARIABLE</h4>
        </div>
      <div class="modal-body">
        <div class="row">
          <div class="loader-romaneo">
          </div>
          <div class="col-md-10">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="notes">{% trans 'Cliente' %}</label>
                  <input type="text" readonly="true" class="romaneo_client form-control">
                </div>                
              </div>          
              <div class="col-md-2">

                <div class="form-group">
                  <label for="notes">{% trans 'Código Producto' %}</label>
                  <input type="text" readonly="true" class="romaneo_product_code form-control">
                </div> 

                
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="notes">{% trans 'Producto' %}</label>
                  <input type="text" readonly="true" class="romaneo_product_description form-control">
                </div>
              </div>
        </div>
        <div class="col-md-2">          
        </div>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="col-md-2">
              <div class="form-group">
                  <label for="notes">{% trans 'Lote Tarima' %}</label>
                  <input type="text" readonly="true" class="romaneo_lote_tarima form-control">
                </div>
            </div>

            <div class="col-md-2">
              <div class="form-group">
                  <label for="notes"> {% trans 'Cajas' %}</label>
                  <input type="text" readonly="true" class="romaneo_cajas form-control">
                </div>
            </div>

            <div class="col-md-3">
              <div class="form-group">
                  <label for="notes">{% trans 'Caducidad' %}</label>
                  <input type="text" readonly="true" class="romaneo_exit_date form-control">
              </div>
            </div>

            <div class="col-md-2">
              <div class="form-group">
                  <label for="notes">{% trans 'Peso Bruto' %}</label>
                  <input type="text" readonly="true" class="romaneo_peso_bruto form-control">
                </div>
            </div>

            <div class="col-md-2">
              <div class="form-group">
                  <label for="notes">{% trans 'Peso Neto' %}</label>
                  <input type="text" readonly="true" class="romaneo_peso_neto form-control">
                </div>             
            </div>
          </div>
          <div class="col-md-4">            
          </div>          
        </div>
        <br>
        <br>
        <input type="hidden" readonly="true" class="romaneo_pallet_id form-control">
        <input type="hidden" readonly="true" class="romaneo_product_bar_code form-control">
        <div class="box_peso_veriable" style="max-height: 360px; overflow-y: auto; margin:20px ">
        <div class="row box_peso_veriable_apend">
          
        </div>        
          
        </div>

        <div class="modal-footer">          
          {{object.werehouse_entrance}}
           <button type="button" class="btn btn-success barcode_scanner">{% trans 'LECTURA DE CODIGOS' %}</button> 
          <label class="label label-info error-msg"></label>
          <button type="button" class="btn btn-primary romaneo_submit">{% trans 'Save' %}</button>
          <button type="button" class="btn btn-default romaneo_cancle">{% trans 'Cancel' %}</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="pallet_warehouse" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content" style="
      border-radius: 6px;">
      <div class="modal-body">
        <div class="row">
          <div class="loader-section">
          </div>
          <div class="box" align="center">
            <div class="box-header">
              <h3 class="box-title">{%trans 'Warehouse' %}</h3>
              <div class="form-group">

                <select class="form-control" id="warehouse_select_id">
                  <option value="">---------</option>
                  {% for warehouse in warehouses %}
                  <option value="{{warehouse.id}}">{{warehouse.code}}</option>
                  {% endfor %}
                </select>

              </div>

            </div>
            <div class="form-group">
              <button class="btn btn-primary" type="button" onclick="return load_location()">{% trans 'Check locations' %}</button>
            </div>


            <div id="list_location">

            </div>                        
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>

    </div>
  </div>
</div>
<!-- single pallet romanio warning -->

<div class="modal fade romaneo-confirm" id="single-pallete-romaneo-warning"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" data-keyboard="false" >
  <div class="modal-dialog sure-confirmation">
    <div class="modal-content text-center">

      <div class="modal-body confirm-sure">
        <p style="margin: 0 0 30px 0;"></p>

        <button type="button" class="btn btn-default romaneo-No">{% trans 'Ok' %}</button>

      </div>
    </div>
  </div>
</div>

<div id="romanio_pallet_barcode" class="modal fade" role="dialog"  aria-labelledby="myModalLabel"  data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content" style="
    border-radius: 6px;">
    <div class="modal-body">
      <div class="row">
        <div class="col-md-6">
          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label for="notes">{% trans 'Boxes Read' %}</label>
                <input type="text" readonly="true" class="form-control weight_count" value="0">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                  <label for="notes">{% trans 'Weight Read' %}</label>
                  <input type="text" readonly="true" class="total_weight_kg_count form-control" value="0">
                </div>
            </div>
          </div>

        </div>
        <div class="col-md-6">
          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                  <label for="notes">{% trans 'Barcode' %}</label>
                  <input type="text" min="0" class="barcode_reader form-control">
                </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                  <label for="notes"></label>
                  <textarea rows="10" style="height:100%; width: 100%;" class="barcode_total_read" readonly="true"></textarea>
                </div>
            </div>
          </div>
          
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary barcode_scanner_submit" disabled="disabled">{% trans 'Save' %}</button>

        <button type="button" class="btn btn-default barcode_scanner_cancle_button" data-dismiss="modal">{% trans 'Cancel' %}</button>
      </div>
    </div>

  </div>
</div>
</div>

{% endblock %}


{% block header-links %}
  <link rel="stylesheet" href="{%static 'custom/warehouse/css/warehouse-entrance.css' %}">
  <style type="text/css">
   .romaneo-confirm{
    z-index:99999 !important; 
   }
  </style>
{% endblock %}


{% block scripts %}
  
  <script src="{% static 'theme/js/jquery.are-you-sure.min.js' %}"></script>
  <script src="{% static 'theme/js/django-formset.js' %}"></script>
  <script src="{% static 'custom/warehouse/js/entrance_detail.js' %}"></script>
  <script src="{% static 'custom/warehouse/js/download_pdf.js' %}"></script>
<script >
  $(".hide_field").parent().addClass('hide')
  load_products()
  var $romaneo_row = null;

  function load_count_boxes(){
  
     $(".row.warehouseentranceconfirmation_set").each(function(){
      
      var total_boxes_value=0
      var total_gross_value=0
      var total_net_value=0
       
      if($(this).find(".table-scroll .pallete_form_list .table-row").length){

          $(this).find('.boxes').each(function(){
          if($(this).val()!=''){
            total_boxes_value += parseInt($(this).val())
          }
          
        })
        $(this).find('.total_boxes').val(total_boxes_value);

        $(this).find('.table-scroll .net_weight').each(function(){
          if($(this).val() == ''){
            $(this).val(0.0)
          }

          total_net_value += parseFloat($(this).val())
        })
        $(this).find('.total_net_weight').val(total_net_value.toFixed(3));
        $(this).find('.table-scroll .gross_weight').each(function(){
          if($(this).val() == ''){
            $(this).val(0.0)
          }
          total_gross_value += parseFloat($(this).val())
        })
        $(this).find('.total_gross_weight').val(total_gross_value.toFixed(3));
        $(this).find('.total_plate_gross_weight').val(total_gross_value.toFixed(3));
        
        $(this).find('.table-row-total').removeClass("hide");
        
        }
      else
      {
          $(this).find('.table-row-total').addClass("hide");
      }

    
    });
  
}

  $(document).on('click', '.qr_generater_button', function() {
    var pallets = []
    $(this).closest('.table-scroll').find('.pallete_form_list').find('.delete-block').each(function(){
      if($(this).find('input').is(':checked')){
        id = $(this).parent().find('.id-pallet').attr('data-pallet-id')
        gross_weight = $(this).parent().find('.gross_weight').val()
        net_weight = $(this).parent().find('.net_weight').val()
        pallets.push({id:id , gross_weight: gross_weight, net_weight: net_weight})
      }
    })
    if(pallets.length > 0){
      var plainText = JSON.stringify(pallets);
      window.open("{% url 'get-entrance-palet-qrcode' %}" + "?qs=" + btoa(plainText), '_blank');
      // Unclick these
      $(this).closest('.table-scroll').find('.pallete_form_list').find('.delete-block').each(function(){
        if($(this).find('input').is(':checked') && $(this).parent().find('.location').val() != ""){
          $(this).find('input').prop('checked', false)
        }
      })
    }
  })



  function addConfirmProduct(is_dual, position) {
    var selected= $('.warehouseentranceconfirmation_set[data-role="w_entrance_confirmation_pallet_row_{0}"]'.f(position))

    if(is_dual) {
      var id_form = $("#id_warehouseentranceconfirmation_set-TOTAL_FORMS");
      var form_idx = id_form.val();

      if(selected.length == 1)
      {
        $("#id_warehouseentranceconfirmation_set-{0}-id".f(position)).next().show()
        $("#id_warehouseentranceconfirmation_set-{0}-DELETE".f(position)).attr("checked", false)
        $("#id_warehouseentranceconfirmation_set-{0}-id".f(position)).show()
      }
      else{
        $('#entrance_product_detail').find(".form-group-list").append($('#empty_product_detail_form').html().replace(/__prefix__/g, position));

        measurement = $("tbody.partial_product tr.active_p").attr('data-measurement')

        $("#id_warehouseentranceconfirmation_set-{0}-w_product_measurement ".f(position)).closest('.warehouseentranceconfirmation_set').addClass("measurement_"+measurement)
        
        $("#id_warehouseentranceconfirmation_set-{0}-w_product_measurement".f(position)).val(measurement)
       
      }
      id_form.val(parseInt(form_idx) + 1);
    }
    else{

      var id_form = $("#id_warehouseentranceconfirmation_set-TOTAL_FORMS");
      var form_idx = id_form.val();
      if($("#id_warehouseentranceconfirmation_set-{0}-id".f(position)).val() == ''){
        id_form.val(parseInt(form_idx) - 1);
      }
      

      if(selected.length == 1){
        if($("#id_warehouseentranceconfirmation_set-{0}-id".f(position)).val() != ''){
          $("#id_warehouseentranceconfirmation_set-{0}-id".f(position)).next().hide()
          $("#id_warehouseentranceconfirmation_set-{0}-DELETE".f(position)).attr("checked", true)
          $("#id_warehouseentranceconfirmation_set-{0}-id".f(position)).hide()
        }
        else{
          selected.remove()
        }
      }

    }
    $('#id_warehouseentranceconfirmation_set-{0}-exp_date'.f(position)).datepicker({
      autoclose: false,
      format: 'yyyy-mm-dd',
    }).datepicker("setDate", new Date());
  }

  load_count_boxes()

  $(document).ready(function() {
    $("[id$=image-clear_id]").css({'display': "none"})
    $("[id$=image-clear_id]").next().css({'display': "none"})
    $('form').areYouSure();

    $('#entrance_date').datepicker({
      autoclose: false,
      format: 'yyyy-mm-dd',
    })

    $('.datepicker').datepicker({
      autoclose: false,
      format: 'yyyy-mm-dd',
    })
  });


$(document).on("click",".appDetails", function () {
    $("#pallet_warehouse").modal('show')
   var warehouse = $(this).closest('.row').find('.warehouse');
   var rack_number = $(this).closest('.row').find('.rack_number');
   var location = $(this).closest('.row').find('.location');   
});

$(document).on("click",".barcode_scanner", function () {
  $("#romanio_pallet_barcode").modal('show')
  localStorage.setItem("barcode_reader_codes", JSON.stringify([]))
  localStorage.setItem("barcode_weight_kg", JSON.stringify([]))
  var stored_datas = JSON.parse(localStorage["barcode_reader_codes"]);
  $(".barcode_total_read").val("")
  $(".barcode_reader").val("")
  $(".weight_count").val(0)
  $(".total_weight_kg_count").val(0)
  $(".barcode_reader").removeAttr("readonly")
  $(".barcode_scanner_submit").attr("disabled", "disabled")
});



$(document).on("keypress",".barcode_reader", function (e) {
  var key = e.which;
  console.log(key)
  if(key == 13) {
    var barcode_reader_val = $(this).val();
    
    if (barcode_reader_val.length <=23 ){
      alert("Ingrese el código de barras correcto.")
    }
    else{
      if (localStorage["barcode_reader_codes"]){

      }
      else{
        localStorage.setItem("barcode_reader_codes", JSON.stringify([]));
      }
      if (localStorage["barcode_weight_kg"]){
      }
      else{
        localStorage.setItem("barcode_weight_kg", JSON.stringify([]));
      }
      var stored_bar_code_reader = JSON.parse(localStorage.getItem("barcode_reader_codes"));
      var stored_bar_code_weight = JSON.parse(localStorage.getItem("barcode_weight_kg"));
      if (stored_bar_code_reader.includes(barcode_reader_val)){
        alert("El código de barras ya está escaneado")
      }
      else{
        stored_bar_code_reader.push(barcode_reader_val)

        localStorage.setItem("barcode_reader_codes", JSON.stringify(stored_bar_code_reader));
        local_storage_code_data = JSON.parse(localStorage.getItem("barcode_reader_codes")).toString()
        local_storage_code_data = local_storage_code_data.replace(/,+/g, '\n ') 
        $(".barcode_total_read").val(local_storage_code_data)
        weight_count = $(".weight_count").val()
        weight_count = parseInt(weight_count) + 1
        $(".weight_count").val(weight_count)
        product_bar_code = $(".partial_product").find('.active_p').find('.product_bar_code').val()
        var total_val = calculate_barcode_weight_val(barcode_reader_val, product_bar_code)
        
        stored_bar_code_weight.push(total_val)
        localStorage.setItem("barcode_weight_kg", JSON.stringify(stored_bar_code_weight));
        total_weight = eval(JSON.parse(localStorage["barcode_weight_kg"]).join("+"))
        total_weight = parseFloat(total_weight).toFixed(3)
        $(".total_weight_kg_count").val(total_weight)
        if($(".romaneo_peso_variable").length == parseInt(weight_count)){
          $(".barcode_reader").attr("readonly", true)
          $(".barcode_scanner_submit").removeAttr("disabled")
          alert("Todo el código de barras se escanea correctamente")
        }
        else{
          $(".barcode_reader").removeAttr("readonly")
          $(".barcode_scanner_submit").attr("disabled", "disabled")
        }
        }
      }
      $(".barcode_reader").val("")
    }
    

  })

$(document).on("click", ".barcode_scanner_submit", function(){
  barcode_weight_kg = JSON.parse(localStorage["barcode_weight_kg"])
  if (barcode_weight_kg.length > 0){
    $( ".romaneo_peso_variable" ).each(function( index ) {
      $(this).val(barcode_weight_kg[index])
    })
  }
  $("#romanio_pallet_barcode").modal("hide")
  localStorage.setItem("barcode_reader_codes", JSON.stringify([]));
  localStorage.setItem("barcode_weight_kg", JSON.stringify([]));
  $(".romaneo_peso_variable").blur()
})

$(document).on("click", ".barcode_scanner_cancle_button", function(){
  localStorage.setItem("barcode_reader_codes", JSON.stringify([]));
  localStorage.setItem("barcode_weight_kg", JSON.stringify([]));
})



$(document).on("blur change",".net_weight", function () {
  net_weight = parseFloat($(this).val())
  active_total_kg = parseFloat($(".partial_product").find('.active_p').find('.total_kg').text())
  if (net_weight > active_total_kg) {
    alert("Existen diferencias entre el peso del producto y la sumatoria de pesos del romaneo. Verifique")
    $(this).closest(".row.warehouseentranceconfirmation_set").find(".net_weight").each(function(){
      $(this).val(net_weight)
       // $(this).val($(this).attr("value"))
    })
    change_singlepallet_netweight($(this));
    // $(this).closest(".row.warehouseentranceconfirmation_set").find(".total_net_weight").val($(this).attr("value"))
  }
  else{
    change_singlepallet_netweight($(this));
  }
})

function change_singlepallet_netweight(e){
  total_net_wight1=0.0
    e.closest(".row.warehouseentranceconfirmation_set").find(".table-scroll .net_weight").each(function(){
      if($(this).val() == ''){
            $(this).val(0.0)
          }
      total_net_wight1 += parseFloat($(this).val())
    })
    e.closest(".row.warehouseentranceconfirmation_set").find(".total_net_weight").val(parseFloat(total_net_wight1))
}

$(document).on("blur change",".gross_weight", function () {
  gross_weight = parseFloat($(this).val())
  active_total_kg = parseFloat($(".partial_product").find('.active_p').find('.total_kg').text())
  if (gross_weight > active_total_kg) {
    alert("Existen diferencias entre el peso del producto y la sumatoria de pesos del romaneo. Verifique")
    
    $(this).closest(".row.warehouseentranceconfirmation_set").find(".gross_weight").each(function(){

      $(this).val(gross_weight)
    })
    change_singlepallet_grossweight($(this));
    // $(this).closest(".row.warehouseentranceconfirmation_set").find(".total_gross_weight").val($(this).attr("value"))
  }else{
    change_singlepallet_grossweight($(this));
  }
})

function change_singlepallet_grossweight(e){
  total_gross_weight_val=0.0
     
    e.closest(".warehouseentranceconfirmation_set").find(".table-scroll .gross_weight").each(function(){
      if($(this).val() == ''){
            $(this).val(0.0)
          }
      total_gross_weight_val +=parseFloat($(this).val())
    })

    e.closest(".warehouseentranceconfirmation_set").find(".total_gross_weight").val(parseFloat(total_gross_weight_val))
}

$(document).on("click",".romaneo", function () {
  $romaneo_row = $(this).closest('.table-row')
  if($(this).closest('.warehouseentranceconfirmation_set').hasClass('active_p')){
    $(".romaneo_clicked").removeClass('romaneo_clicked')
    $(this).addClass('romaneo_clicked')
    product = $(this).closest('.row').parent().parent().parent().find('.product  option:selected').val()
    var description = $(".partial_product").find('.active_p').find('.product_description').text()
    var code = $(".partial_product").find('.active_p').find('.product_code').text()
    var product_bar_code = $(".partial_product").find('.active_p').find('.product_bar_code').val()
    
    
    palet_lot = $(this).closest('.row').find('.palet_lot').val()
    boxes = $(this).closest('.row').find('.boxes').val()
    exp_date = $(this).closest('.row').find('.exp_date').val()
    gross_weight = $(this).closest('.row').find('.gross_weight').val()
    net_weight = $(this).closest('.row').find('.net_weight').val()
    id_pallet = $(this).closest('.row').find(".id-pallet").attr('data-pallet-id')

  
    div_data = $( "<div class='loader-image'> <img src='{% static 'theme/img/loader.gif' %}' alt='loader'/ ></div> " )
    $(".loader-romaneo").append(div_data)
    $("#pallet_romaneo").modal('show')
    $(".romaneo_client").val($("#id_customer").attr('data-name'))
    $(".romaneo_product_code").val(code)
    $(".romaneo_product_description").val(description)
    $(".romaneo_lote_tarima").val(palet_lot)
    $(".romaneo_cajas").val(boxes)
    $(".romaneo_exit_date").val(exp_date)
    $(".romaneo_peso_bruto").val(parseFloat(gross_weight).toFixed(3))
    $(".romaneo_peso_neto").val(parseFloat(net_weight).toFixed(3))
    $(".romaneo_pallet_id").val(id_pallet)
    $(".romaneo_product_bar_code").val(product_bar_code)
    barcodes = ["bc_sasa", "BC_Yoreme", "BC_LaVeinte", "BC_Carnicos",
    "BC_GCM", "BC_Cicaba", "BC_Integra", "BC_Integra2", "BC_Bonacarne", "BC_Soles", "Codigo Ayvi"]
    id_customer_barcoderead = $("#id_customer_barcoderead").val()
    product_bar_code_exists = false
    if($.inArray(product_bar_code, barcodes) > -1)
    {
      product_bar_code_exists = true
    }
    if( id_customer_barcoderead == "True" && product_bar_code_exists){
      $(".barcode_scanner").removeClass("hide")
    }
    else{
      $(".barcode_scanner").addClass("hide")
    }
    jQuery.ajax( {
      url: "{% url 'get-pallet-peso-variable' 0 %}".replace('0', id_pallet),
      type: "GET",
      dataType: "json",
    } ).done( function( response )
    {
      $(".box_peso_veriable").find('.box_peso_veriable_apend').html('')
      console.log(response)
      peso_html=""
      romaneo_cajas_count = parseInt($(".romaneo_cajas").val());

      if (response.code == 200) {
        if(romaneo_cajas_count >= response.data.length){
          response.data.forEach(function(item){
            peso_html = "<div class='col-md-2'><div class='form-group'><input type='number' min='0' onkeypress='return checkDecimal(event, this, 5, 3);' class='romaneo_peso_variable form-control' value="+ item.peso_variable_quantity +"  data-peso-variable="+ item.id +"></div></div>"+peso_html
          })
          
          remaining_cajas=romaneo_cajas_count-response.data.length
          for (i = 0; i < remaining_cajas; i++) { 
            peso_html = "<div class='col-md-2'><div class='form-group'><input type='number' min='0' onkeypress=' return checkDecimal(event, this, 5, 3);' class='romaneo_peso_variable form-control' value='0.0' data-peso-variable=''></div></div>"+peso_html
          }  

         }
        else if(romaneo_cajas_count < response.data.length){
            peso_variables = response.data.slice(0, romaneo_cajas_count);
            peso_variables.forEach(function(item){
              peso_html = "<div class='col-md-2'><div class='form-group'><input type='number' min='0' onkeypress='return checkDecimal(event, this, 5, 3);' class='romaneo_peso_variable form-control' value="+ item.peso_variable_quantity +"  data-peso-variable="+ item.id +"></div></div>"+peso_html
            })
          }

      }
      else{  
        for (i = 0; i < romaneo_cajas_count; i++) { 
          peso_html = "<div class='col-md-2'><div class='form-group'><input type='number' min='0' onkeypress=' return checkDecimal(event, this, 5, 3);' class='romaneo_peso_variable form-control' value='0.0' data-peso-variable=''></div></div>"+peso_html
        }  
      }
      $(".box_peso_veriable").find('.box_peso_veriable_apend').append(peso_html)
      $('.romaneo_peso_variable:first').select();
      $('.romaneo_peso_variable:first').focus()

      total_values= 0
      $(".romaneo_peso_variable").each(function(){
        if($(this).val()==""){
          $(this).val(0)
        }
        total_values += parseFloat($(this).val()  )  
      })
      $(".romaneo_peso_neto").val(total_values.toFixed(3))
      $(".romaneo_peso_bruto").val(total_values.toFixed(3))
      $(".loader-romaneo").html('')
      
    })
}
else
  {
    alert("Por favor, seleccione primero el producto");
  }
});


function checkDecimal(evt, item, lenBeforeDecimal, lenAfterDecimal) {
  var charCode = evt.which;
 
  var trimmed = $(item).val().replace(/\b^0+/g, "");
  if(checkStartsWith(trimmed, '.') == true){
    trimmed = '0' + trimmed;
  }  
  
  if(charCode == 8 || charCode == 9){
    return true;
  } 

  if(charCode == 46){
    var dotOccurrences = (trimmed.match(/\./g) || []).length;
    
    if(dotOccurrences != undefined && dotOccurrences == 1){
      return false;
    }else{
      return true;
    }
  }
  
  if (charCode > 31 && ((charCode < 48) || (charCode > 57))) {
    return false;
  }
    if ($(item).val() != trimmed){
        $(item).val(trimmed);}  
  
  if(trimmed.indexOf('.') == -1){
    if(trimmed.length >= parseInt(lenBeforeDecimal)){
      return false;
    }
  }else{
    // GGV
    var inputArr = trimmed.split(".");
    // if(inputArr[1].length >= parseInt(lenAfterDecimal) && charCode != 13){
    //  $(item).val(0)
    //}
    //if(inputArr[0].length > parseInt(lenBeforeDecimal) || inputArr[1].length >= parseInt(lenAfterDecimal)){
    //   return false;
    //}
  }
  
  return true;
}
function checkStartsWith(str, prefix){
  return str.indexOf(prefix) === 0;
}

$(document).on("blur",".romaneo_peso_variable", function () {
  total_values= 0
  $(".romaneo_peso_variable").each(function(){
    if($(this).val()=="")
    {
      $(this).val(0)
    }
    total_values += parseFloat($(this).val())  
      })
  $(".romaneo_peso_neto").val(total_values.toFixed(3))
  $(".romaneo_peso_bruto").val(total_values.toFixed(3))

})


$(document).on("click",".romaneo_cancle", function () {
   $("#pallet_romaneo").modal('hide')
})


$(document).on("keypress",".romaneo_peso_variable", function (e) {
  if(e.which === 13){
    focus_input = $(this).parent().parent().next().find('input')
    if(focus_input.hasClass('romaneo_peso_variable')){
      focus_input.select();
      focus_input.focus()

    }
    else{
      $('.romaneo_peso_variable:first').select();
      $('.romaneo_peso_variable:first').focus()
    }
  }

})

$(document).on("keypress",".move_next", function (e) {
  if(e.which === 13){
    e.preventDefault();
    focus_input = $(this).parent().next().find('input')
    if(focus_input.length!= 0 && focus_input.hasClass('move_next')){

      focus_input.select();
      focus_input.focus()
    }
    else{
      $(this).parent().parent().find('.move_next:eq(1)').select();
      $(this).parent().parent().find('.move_next:eq(1)').focus()
    }
  }

})


function load_location(){
  $("#list_location").empty()

  warehouse = $("#warehouse_select_id").val()
  if(warehouse != '')
  {
    div_data = $( "<div class='loader-image'> <img src='{% static 'theme/img/loader.gif' %}' alt='loader'/ ></div> " )
    $(".loader-section").append(div_data)

    jQuery.ajax( {
      url: "{% url 'warehouse-location-detail' 0 %}".replace('0', warehouse),
      type: "GET",
      dataType: "json",
    } ).done( function( response )
    {
      $("#list_location").append(response.warehouse)
      $(".loader-section").html('')
    })
  }

}

function set_status(value){
  localStorage.removeItem('entrance_id')
  localStorage.removeItem('data_role')
  $(".validation-error").removeClass('validation-error')
  if(value != 'Guardar'){
    var error = false;
    var error_data = false;
    $("#entrance_product_detail").find(".warehouseentranceconfirmation_set:visible").each(function(){ 
      $(this).find(".skip_validation").each(function(){  
        if($(this).val() == ''){
          $(this).addClass('validation-error')
          error = true;
        }
      })

    })
    if(error){
      
      alert("{% trans 'Please fill all details of product code ' %}"+ String($(".partial_product").find('.active_p .product_code p').text()))
    }
    else
    {      
      $(".pallete_form_list .required-field").each(function(){
        if($(this).val()== ''){
          $(this).addClass('validation-error')
          error_data = true
          
        }  

      $(".pallete_form_list .gross_weight").each(function(){
        if(parseFloat($(this).val())<= 0){
          $(this).addClass('validation-error')
          error_data = true          
        }        
      });

      $(".pallete_form_list .net_weight").each(function(){
        if(parseFloat($(this).val())<= 0){
          $(this).addClass('validation-error')
          error_data = true
          
        }        
      });

      });
    }

    if(error_data == false && error == false){
      return true
   }
   else{
     return false
   
     }
  }

}

$(".pallet_required_boxes").blur(function(){
  
  var kg_per_box = parseFloat($(".partial_product").find("tr.active_p").find(".kg_per_boxes").text())
  if(isNaN(kg_per_box) != true){
      box_kg = parseFloat(kg_per_box * parseFloat($(this).val())).toFixed(3)
      $(this).parent().next().find('input').val(box_kg)
    }
  
})


$("#accept").click(function(){
  $("#id_status").val("finish")
  $.LoadingOverlay("show");

  var xhr = new XMLHttpRequest();
  xhr.open("POST", ""); 
  xhr.responseType= 'blob';
  xhr.onload = function(event){ 
      $.LoadingOverlay("hide");
      download_pdf(event.target.response, "Entrada_{{object.id}}_"+new Date().toLocaleDateString()+".pdf")
      window.location = '/warehouse_entrance/warehouse-entrances-list';
  }; 
  // or onerror, onabort
  var formData = new FormData(document.getElementById("sga-form")); 
  xhr.send(formData);

})

$("#reject").click(function(){
  $("#sga-form").submit();
})
$("#sga-entrance-form").click(function(e){
  e.preventDefault()
  $("#id_status").val("pending")
  $( "#sga-form" ).submit();
})
$("#confirm_button").click(function(){
  confirmation = set_status('CONFIRM ENTRANCE')
  if(confirmation){
     $('#modal-sure-confirm').modal('show');                  
   }
   else
   {
     $('#modal-error-confirm').modal('show');
   
   }
})

$(".appDetails").click(function(){
  $(".appDetails").removeClass('active')
  $(this).addClass('active')
})
// disabled button if pallet not completed
// setInterval(function(){
  check_pallet_status()
// }, 100)
function check_pallet_status(){
  var mark_disabled = false;
  $("#entrance_product_detail").find(".form-group-list").find(".warehouseentranceconfirmation_set").each(function(){
    
    $(this).find(".table-scroll").find('.pallete_form_list').find(".table-row").each(function(){
      if($(this).find(".location option:selected").val() == undefined || $(this).find(".location option:selected").val() == ""){
        mark_disabled = true
      }
    })
  })
  var current_status = "{{object.status}}";
  $(".send_to_maneuvers").prop('disabled', mark_disabled)
  $("#confirm_button").prop('disabled', true)
  if(current_status == "ManeuverComplete"){
    $("#confirm_button").prop('disabled', false)
  }

  if(current_status == "InManeuvers"){
    $(".send_to_maneuvers").prop('disabled', true)
  }
}

$(".submit_data").click(function(){
  prod_position = $(this).closest('.warehouseentranceconfirmation_set').find('.product').attr('name')
  data_role = $(this).closest('.warehouseentranceconfirmation_set').attr('data-role')
  postion_data = data_role.replace ( /[^\d.]/g, '' );
  position = prod_position.replace ( /[^\d.]/g, '' );
  $(".validation-error").removeClass('validation-error')
    var error = false;
    var error_data = false;
 
    if(error_data == false && error == false){
      $(".check_to_redirect").val('true')
      pallet_arr = []
      confirmation_array=[]
      w_confirmation_id = $("#id_warehouseentranceconfirmation_set-"+position+"-id").val()
      if (w_confirmation_id!=""){
        confirmation_hash = {
          "w_confirmation_id":w_confirmation_id,
          "cost_lot":$("#id_warehouseentranceconfirmation_set-"+position+"-cost_lot").val(),
          "exp_date":$("#id_warehouseentranceconfirmation_set-"+position+"-exp_date").val(),
          "gross_weight":$("#id_warehouseentranceconfirmation_set-"+position+"-gross_weight").val(),
          "net_weight":$("#id_warehouseentranceconfirmation_set-"+position+"-net_weight").val(),
           "invoice_weight":$("#id_warehouseentranceconfirmation_set-"+position+"-invoice_weight").val(), 
           "retained_quantity":$("#id_warehouseentranceconfirmation_set-"+position+"-retained_quantity").val(), 
           "retained_reason":$("#id_warehouseentranceconfirmation_set-"+position+"-retained_reason").val()
          }

         confirmation_array.push(confirmation_hash)

      }
      $(this).closest('.warehouseentranceconfirmation_set').find('.pallete_form_list .table-row').each(function(){ 
        palet_id = $(this).find('.pallet_column.id-pallet').attr('data-pallet-id')
        delete_pallet = $(this).find('.pallet_column.delete-block').find('input')
        will_delete = "false"
        if (delete_pallet != null) {
          if(delete_pallet.prop('checked')){
            will_delete = "true"
          }
        }

        console.log(will_delete)
        palet_lot = $(this).find('.pallet_column .palet_lot').val()
        boxes = $(this).find('.pallet_column .boxes').val()
        box_kg = $(this).find('.pallet_column .box_kg').val()
        warehouse = $(this).find('.pallet_column .warehouse').val()
        rack_number = $(this).find('.pallet_column .rack_number').val()
        warehouse_location = $(this).find('.pallet_column .location').val()
        cost_lot = $(this).find('.pallet_column .cost_lot').val()
        exp_date = $(this).find('.pallet_column .exp_date').val()
        gross_weight = $(this).find('.pallet_column .gross_weight').val()
        net_weight = $(this).find('.pallet_column .net_weight').val()
        invoice_weight = $(this).find('.pallet_column .invoice_weight').val()
        retained_quantity = $(this).find('.pallet_column .retained_quantity').val()
        retained_reason = $(this).find('.pallet_column .retained_reason').val()
        confirmation_id = $("#id_warehouseentranceconfirmation_set-"+position+"-id").val()
        if (palet_id == null) {
          palet_id = ""
        }

        pallet_hash = {
         "palet_lot":palet_lot,
         "boxes":boxes,
         "box_kg":box_kg,
         "warehouse":warehouse,
         "rack_number":rack_number, 
         "warehouse_location":warehouse_location, 
         "cost_lot":cost_lot, 
         "exp_date":exp_date,
         "gross_weight":gross_weight, 
         "net_weight":net_weight,
         "invoice_weight":invoice_weight,
         "retained_quantity":retained_quantity, 
         "retained_reason":retained_reason,
         'confirmation_id': confirmation_id,
         'palet_id': palet_id,
         'deleteconfirmation_hashd': will_delete
          }
        pallet_arr.push(pallet_hash)

    })
      div_data = $( "<div class='picking-loader-image'> <img src='/static/theme/img/loader.gif' alt='loader'/ ></div> " )
      $(".parent-loader").append(div_data)
      $.LoadingOverlay('show')
      jQuery.ajax( {
        url: "{% url 'save-entrance-pallet' %}",
        type: "POST",
        dataType: "json",
        data: {
          pallet_arr: JSON.stringify(pallet_arr),
          confirmation_array: JSON.stringify(confirmation_array),
        }
      } ).done( function( response )
      {

        if (response["code"] == "200") {
          $(".parent-loader").find(".picking-loader-image").fadeOut(1000, function(){ $(this).remove();});
            location.reload(true);
        }  else{
          $.LoadingOverlay('hide')
        }      
      })
    }    
})


$(document).ready(function(){
  localStorage.removeItem('entrance_id')
  localStorage.removeItem('data_role')
})

$(".cancle_button").click(function(){
  $("#entrance_confirmation_modal").modal('hide')
})

$(document).on("blur",".pallete_form_list .retained_quantity", function () {
  box_value = $(this).parent().parent().find('.boxes').val()
  if(parseInt(box_value) < parseInt($(this).val())){
    alert("Qauntity retenida no debe ser mayor que la cantidad de caja")
    $(this).val(0)
  }
})

$("#warehouse-catalogs .entrace").addClass('active')

</script>


{% block additional-custom-scripts %}
{% include 'warehouse/warehouse_entrance/sidebar.html' %}
{% endblock %}
{% endblock %}

